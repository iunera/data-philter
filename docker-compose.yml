services:

  # Druid MCP Server
  # This service runs the Druid MCP server, which is the backend that connects to Druid.
  druid-mcp-server:
    image: iunera/druid-mcp-server:latest
    pull_policy: always
    env_file:
      - druid.env
    environment:
      SPRING_PROFILES_ACTIVE: http

  # Ollama Check
  # This service checks if Ollama is running before the core service starts.
  ollama-check:
    image: curlimages/curl:latest
    command: ["sh", "-c", "until curl --fail http://host.docker.internal:11434/; do echo 'Waiting for Ollama...'; sleep 5; done"]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Philter Core
  # This is the main application, the "philter-core". It depends on the `druid-mcp-server`.
  core:
    image: iunera/philter-core:latest
    pull_policy: always
    environment:
      SPRING_PROFILES_ACTIVE: docker
    env_file:
      - app.env
    volumes:
      - philter_data:/data
    depends_on:
      druid-mcp-server:
        condition: service_started
      ollama-check:
        condition: service_completed_successfully
    restart: unless-stopped

  # Philter UI
  # This is the frontend application, the "philter-ui". It depends on the `core` service.
  ui:
    image: iunera/philter-ui:latest
    pull_policy: always
    ports:
      - "3000:3000"
    env_file:
      - app.env
    depends_on:
      core:
        condition: service_started
    restart: unless-stopped

volumes:
  philter_data: