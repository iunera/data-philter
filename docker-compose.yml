services:

  # Druid MCP Server
  # This service runs the Druid MCP server, which is the backend that connects to Druid.
  druid-mcp-server:
    image: iunera/druid-mcp-server:latest
    pull_policy: always
    env_file:
      - druid.env
    environment:
      SPRING_PROFILES_ACTIVE: http

  # Ollama Check
  # This service checks if Ollama is running before the core service starts.
  ollama-check:
    image: curlimages/curl:latest
    command: ["sh", "-c", "case \"$IUNERA_MODEL_TYPE\" in ollama*) until curl --fail http://host.docker.internal:11434/; do echo 'Waiting for Ollama...'; sleep 5; done ;; *) echo 'Skipping Ollama check for non-Ollama model' ;; esac"]
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file:
      - app.env

  # Philter
  # This is the main application, the "philter". It depends on the `druid-mcp-server` and on the `ollama-check` service.
  philter:
    image: iunera/philter:latest
    pull_policy: always
    environment:
      SPRING_PROFILES_ACTIVE: docker
    env_file:
      - app.env
    volumes:
      - philter_data:/data
    ports:
      - "4000:4000"
    depends_on:
      druid-mcp-server:
        condition: service_started
      ollama-check:
        condition: service_completed_successfully
    restart: unless-stopped

volumes:
  philter_data: